# HIS Connect API

> ‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• nRefer, ISOnline ‡πÅ‡∏•‡∏∞ PHER Plus ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏á‡∏≤‡∏ô Cron, ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™ token ‡πÅ‡∏•‡∏∞‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå Docker ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

## üåü ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏Å

- **nRefer / ISOnline / PHER Plus** API gateway ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ token ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö cron
- **Optimised Cron Manager** (`nodecron.optimized.ts`) ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£ multi-instance ‡∏ú‡πà‡∏≤‡∏ô PM2
- **Secure Refer Token** (`middleware/moph-refer.ts`) ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™ `apikey` ‡∏î‡πâ‡∏ß‡∏¢ SHA-1 ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
- **Multi-platform Docker images** (linux amd64/arm64, Windows) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå build ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î **TypeScript** ‡πÅ‡∏¢‡∏Å `src/` ‚Üí `app/` ‡∏´‡∏•‡∏±‡∏á build

---

## üì¶ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå

```
src/
	app.ts              # ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á Fastify server
	nodecron.optimized.ts  # ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ cron schedule ‡∏´‡∏•‡∏±‡∏Å
	middleware/
		moph-refer.ts     # ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö nRefer + hash apikey
	routes/
		...               # REST routes ‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô cron ‡∏¢‡πà‡∏≠‡∏¢
app/                  # ‡πÇ‡∏Ñ‡πâ‡∏î JS ‡∏ó‡∏µ‡πà build ‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ `npm run build`)
config/               # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ environment (‡∏î‡∏π config.example)
create_docker_image.sh # ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå build/push container
Dockerfile            # Production image (multi-stage, non-root, Node 20-alpine)
```

---

## ‚úÖ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô

- Node.js **20** ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ ‡πÅ‡∏•‡∏∞ npm
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (MySQL/MariaDB, MSSQL, PostgreSQL, Oracle) ‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô `config`
- PM2 (‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô Docker image / ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏≠‡∏á‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡∏ö‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå)
- ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ build Docker (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á image ‡πÄ‡∏≠‡∏á)

---

## üöÄ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö Node.js

1. **‡πÇ‡∏Ñ‡∏•‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à**
	 ```bash
	 git clone https://github.com/superpck/his-connect.git
	 cd his-connect
	 npm install
	 ```

2. **‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ environment**
	 - ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å `config.example` ‡πÑ‡∏õ‡∏¢‡∏±‡∏á `config` ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•, API key, hospcode ‡∏Ø‡∏•‡∏Ø
	 - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå `.env` ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô `process.env` ‡πÄ‡∏ä‡πà‡∏ô `NREFER_APIKEY`, `NREFER_SECRETKEY`, `REQUEST_KEY`

3. **‡∏Ñ‡∏≠‡∏°‡πÑ‡∏û‡∏•‡πå TypeScript ‚Üí JavaScript**
	 ```bash
	 npm run build
	 ```
	 ‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `app/`

4. **‡∏£‡∏±‡∏ô‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏û‡∏±‡∏í‡∏ô‡∏≤**
	 ```bash
	 npm start
	 ```
	 ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ `npm run watch` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö nodemon (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö TypeScript ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)

---

## üê≥ ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Docker

### ‡∏î‡∏∂‡∏á image ‡∏ó‡∏µ‡πà‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
```bash
docker pull superpck/his-connect:linux-latest   # multi-arch (amd64/arm64)
docker pull superpck/his-connect:latest         # linux/amd64
docker pull superpck/his-connect:windows-latest # ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Windows builder
```

### ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô container ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß
```bash
docker run -d \
	--name his-connect \
	-p 3004:3004 \
	-v $(pwd)/config:/usr/src/his_connect/config \
	-e HOSPCODE=XXXXXX \
	superpck/his-connect:latest
```

### ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á image (`create_docker_image.sh`)

‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞:

1. ‡∏Ñ‡∏≠‡∏°‡πÑ‡∏û‡∏•‡πå TypeScript ‡πÅ‡∏•‡∏∞‡∏•‡∏ö sourcemap
2. ‡∏î‡∏∂‡∏á base image (`node:20-alpine`)
3. ‡∏™‡∏£‡πâ‡∏≤‡∏á multi-arch image ‡∏î‡πâ‡∏ß‡∏¢ Docker Buildx (linux + windows)
4. Push ‡∏Ç‡∏∂‡πâ‡∏ô Docker Hub

‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ‡∏ú‡πà‡∏≤‡∏ô environment variable:

| ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ | ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô | ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ |
| --- | --- | --- |
| `ENABLE_SYSTEM_PRUNE` | `false` | ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ `true` ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ `docker system prune` ‡∏Å‡πà‡∏≠‡∏ô build |
| `ENABLE_WINDOWS_BUILD` | `false` | ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ `true` ‡πÄ‡∏û‡∏∑‡πà‡∏≠ build image ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Windows |
| `ENABLE_SYSTEM_PRUNE_AFTER` | `false` | ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ `true` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö cache ‡∏´‡∏•‡∏±‡∏á build |

> **‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:** ‡∏´‡∏≤‡∏Å‡∏û‡∏ö error `toomanyrequests` ‡∏à‡∏≤‡∏Å Docker Hub ‡πÉ‡∏´‡πâ‡∏ó‡∏≥ `docker login` ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ mirror ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á

---

## ‚è±Ô∏è Cron & Background Jobs

- `src/nodecron.optimized.ts` ‡πÉ‡∏ä‡πâ `node-cron` + PM2 ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ instance ‡πÑ‡∏´‡∏ô‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô ‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á PID ‡∏à‡∏≤‡∏Å PM2
- ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡∏ú‡πà‡∏≤‡∏ô environment variables ‡πÄ‡∏ä‡πà‡∏ô `IS_AUTO_SEND_EVERY_MINUTE`, `NREFER_AUTO_SEND_EVERY_HOUR` ‡∏Ø‡∏•‡∏Ø
- ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (‡πÄ‡∏ä‡πà‡∏ô nRefer IPD, IS Online) ‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å ‡πÜ X ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡πÉ‡∏ô console

---

## üîê ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ & Token

- `middleware/moph-refer.ts`
	- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡πÄ‡∏î‡∏¥‡∏°‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÉ‡∏´‡∏°‡πà
	- ‡πÅ‡∏Æ‡∏ä `dataArray.apikey` ‡∏î‡πâ‡∏ß‡∏¢ SHA-1 (‡∏≠‡∏¥‡∏á‡∏Ñ‡πà‡∏≤ `REQUEST_KEY`)
	- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ token ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞ log ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏µ‡∏ö‡∏±‡∏Å

‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:

1. ‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå database user ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ `SELECT`
2. ‡∏ß‡∏≤‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å
3. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô ISOnline / Secret key ‡∏ó‡∏∏‡∏Å 3‚Äì6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
4. ‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô

---

## üóÑÔ∏è ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á VIEW (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SSB ‚Äì ‡∏£‡∏û.‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ)

‡∏™‡∏£‡πâ‡∏≤‡∏á VIEW ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö API ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏î‡∏ß‡∏Å:

```
PERSON
OPD_SERVICE
DIAGNOSIS
ADMISSION
```

---

## ü§ù ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤ (Develop@MOPH)

```
git add .
git commit -m "‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"
git push origin <branch>
# ‡∏´‡∏≤‡∏Å push ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ git pull ‡∏Å‡πà‡∏≠‡∏ô
```

---

## üìö ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á

‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô [`CHANGELOG.md`](./CHANGELOG.md)

---

## üôè ‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì

- ‡∏≠.‡∏™‡∏ñ‡∏¥‡∏ï‡∏¢‡πå ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡∏® ‚Äî https://github.com/siteslave